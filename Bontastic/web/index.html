<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bontastic Controlcenter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        green: {
                            50: '#faf5f5',
                            100: '#ebffe5',
                            200: '#ccffbe',
                            300: '#00ea00',
                            400: '#00ea00', // Mapping tint-04
                            500: '#00ff00',
                            600: '#00ea00',
                            700: '#00d300',
                            800: '#00be00',
                            900: '#009900',
                        },
                        secondary: {
                            DEFAULT: '#9673ff',
                            50: '#efe7ff',
                            100: '#d4c4fe',
                            200: '#b69dfe',
                            300: '#7952fe',
                            400: '#5c33f4',
                            500: '#4d2eed',
                        },
                        red: {
                            DEFAULT: '#ff3719',
                            300: '#ff9e8f',
                            500: '#ff3719',
                        },
                        dark: '#141414',
                    },
                    fontFamily: {
                        mono: ['"KarioDuplexVar"'],
                        sans: ['"OfficerSans"'],
                        condensed: ['"OfficerSansCond"',]
                    }
                }
            }
        };
    </script>
    <style>
        @font-face {
            font-family: 'KarioDuplexVar';
            src: URL('assets/fonts/Kario39C3Var-Roman.ttf') format('truetype');
            src: URL('assets/fonts/Kario39C3VarWEB-Roman.woff') format('woff');
            src: URL('assets/fonts/Kario39C3VarWEB-Roman.woff2') format('woff2');
        }

        @font-face {
            font-family: 'OfficerSansCond';
            src: URL('assets/fonts/OfficerSansCondWeb-Regular.woff') format('woff');
            src: URL('assets/fonts/OfficerSansCondWeb-Regular.woff2') format('woff2');
        }

        @font-face {
            font-family: 'OfficerSansCond';
            font-weight: bold;
            font-style: italic;
            src: URL('assets/fonts/OfficerSansCondWeb-BoldItalic.woff') format('woff');
            src: URL('assets/fonts/OfficerSansCondWeb-BoldItalic.woff2') format('woff2');
        }

        @font-face {
            font-family: 'OfficerSansCond';
            font-weight: bold;
            src: URL('assets/fonts/OfficerSansCondWeb-Bold.woff') format('woff');
            src: URL('assets/fonts/OfficerSansCondWeb-Bold.woff2') format('woff2');
        }

        @font-face {
            font-family: 'OfficerSansCond';
            font-style: italic;
            src: URL('assets/fonts/OfficerSansCondWeb-RegularItalic.woff') format('woff');
            src: URL('assets/fonts/OfficerSansCondWeb-RegularItalic.woff2') format('woff2');
        }

        @font-face {
            font-family: 'OfficerSans';
            src: URL('assets/fonts/OfficerSansWeb-Regular.woff') format('woff');
            src: URL('assets/fonts/OfficerSansWeb-Regular.woff2') format('woff2');
        }

        @font-face {
            font-family: 'OfficerSans';
            font-weight: bold;
            font-style: italic;
            src: URL('assets/fonts/OfficerSansWeb-BoldItalic.woff') format('woff');
            src: URL('assets/fonts/OfficerSansWeb-BoldItalic.woff2') format('woff2');
        }

        @font-face {
            font-family: 'OfficerSans';
            font-weight: bold;
            src: URL('assets/fonts/OfficerSansWeb-Bold.woff') format('woff');
            src: URL('assets/fonts/OfficerSansWeb-Bold.woff2') format('woff2');
        }

        @font-face {
            font-family: 'OfficerSans';
            font-style: italic;
            src: URL('assets/fonts/OfficerSansWeb-RegularItalic.woff') format('woff');
            src: URL('assets/fonts/OfficerSansWeb-RegularItalic.woff2') format('woff2');
        }


        :root {
            --color-dark: #141414;
            --color-neutral: #faf5f5;
            --color-primary: #00ff00;
            --color-secondary: #9673ff;
            --color-additional-01: #ff3719;
            --color-additional-02: #66f2ff;
            --color-primary-tint-01: #009900;
            --color-primary-tint-02: #00be00;
            --color-primary-tint-03: #00d300;
            --color-primary-tint-04: #00ea00;
            --color-primary-tint-05: #a3ff90;
            --color-primary-tint-06: #ccffbe;
            --color-primary-tint-07: #ebffe5;
            --color-secondary-tint-01: #4d2eed;
            --color-secondary-tint-02: #5c33f4;
            --color-secondary-tint-03: #7952fe;
            --color-secondary-tint-04: #b69dfe;
            --color-secondary-tint-05: #d4c4fe;
            --color-secondary-tint-06: #efe7ff;
        }

        body {
            background-color: #050505;
            color: var(--color-primary-tint-04);
            font-family: 'OfficerSans', sans-serif;
            background-image: radial-gradient(circle at 1px 1px, #0f0f0f 1px, transparent 0), radial-gradient(circle at 3px 3px, #0d0d0d 1px, transparent 0);
            background-size: 4px 4px;
        }

        .scanlines::after {
            content: '';
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(180deg, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 3px, rgba(0, 0, 0, 0.2) 3px, rgba(0, 0, 0, 0.2) 4px);
            pointer-events: none;
            mix-blend-mode: screen;
        }

        .ghost-grid {
            background-image: linear-gradient(rgba(0, 255, 0, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 0, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        input[type=range] {
            accent-color: var(--color-primary);
        }
    </style>
</head>

<body class="min-h-screen scanlines">
    <div id="app" class="max-w-4xl mx-auto px-5 py-10 space-y-10 relative z-10">
        <header
            class="border border-green-500/40 bg-black/50 backdrop-blur-sm rounded-xl p-6 flex flex-col gap-5 shadow-[0_0_20px_rgba(0,255,0,0.15)]">
            <div class="flex flex-wrap gap-4 justify-between items-start">
                <div>
                    <p class="text-sm font-mono tracking-[0.4em] text-green-400/70">SYSTEM ONLINE</p>
                    <h1 class="text-3xl md:text-4xl font-mono font-medium text-green-300">
                        BONTASTIC <<39C3 </h1>
                </div>
                <div class="flex flex-col items-end text-s font-mono uppercase text-green-300/80">
                    <span>status :: {{ statusText }}</span>
                    <span>device :: {{ connected ? 'linked' : 'idle' }}</span>
                </div>
            </div>
            <div class="flex flex-wrap gap-4 items-center">
                <button @click="connect" :disabled="connecting || connected"
                    class="px-6 py-2 font-mono border border-green-400/60 bg-green-500/10 hover:bg-green-500/20 text-green-200 rounded transition disabled:opacity-50 disabled:cursor-not-allowed">
                    {{ connecting ? 'negotiating…' : 'establish link' }}
                </button>
                <button @click="disconnect" :disabled="!connected"
                    class="px-6 py-2 font-mono border border-red-500/40 bg-red-500/10 hover:bg-red-500/20 text-red-300 rounded transition disabled:opacity-40 disabled:cursor-not-allowed">
                    terminate
                </button>
                <span class="text-sm text-green-400/70">notify :: {{ notificationsEnabled ? 'on' : 'off' }}</span>
            </div>
        </header>

        <main class="space-y-8">
            <section
                class="border border-green-500/20 rounded-xl bg-black/40 p-5 space-y-4 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                <header class="flex justify-between items-center text-green-300">
                    <h2 class="text-lg font-mono tracking-wide">MESHTASTIC LINK</h2>
                </header>
                <div class="grid gap-4 md:grid-cols-2">
                    <div class="space-y-2">
                        <label class="text-xs text-green-400/70 uppercase">Device Name</label>
                        <input type="text" v-model="settings.meshName" @change="updateSetting('meshName')"
                            :disabled="!connected"
                            class="w-full bg-black/60 border border-green-500/40 rounded px-3 py-2 text-green-100 text-sm focus:outline-none focus:border-green-400">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs text-green-400/70 uppercase">Pairing PIN</label>
                        <input type="text" v-model="settings.meshPin" @change="updateSetting('meshPin')"
                            :disabled="!connected"
                            class="w-full bg-black/60 border border-green-500/40 rounded px-3 py-2 text-green-100 text-sm focus:outline-none focus:border-green-400">
                    </div>
                </div>
            </section>

            <section
                class="border border-green-500/20 rounded-xl bg-black/40 p-5 space-y-4 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                <header class="flex justify-between items-center text-green-300">
                    <h2 class="text-lg font-mono tracking-wide">PRINTER CONNECTION</h2>
                </header>
                <div class="grid gap-4 md:grid-cols-2">
                    <div class="space-y-2">
                        <label class="text-xs text-green-400/70 uppercase">Printer RX</label>
                        <input type="number" v-model.number="settings.printerRxPin"
                            @change="updateSetting('printerRxPin')" :disabled="!connected"
                            class="w-full bg-black/60 border border-green-500/40 rounded px-3 py-2 text-green-100 text-sm focus:outline-none focus:border-green-400">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs text-green-400/70 uppercase">Printer TX</label>
                        <input type="number" v-model.number="settings.printerTxPin"
                            @change="updateSetting('printerTxPin')" :disabled="!connected"
                            class="w-full bg-black/60 border border-green-500/40 rounded px-3 py-2 text-green-100 text-sm focus:outline-none focus:border-green-400">
                    </div>
                </div>
            </section>

            <section
                class="border border-green-500/20 rounded-xl bg-black/40 p-5 space-y-4 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                <header class="flex justify-between items-center text-green-300">
                    <h2 class="text-lg font-mono tracking-wide">DIRECT PRINT</h2>
                </header>
                <div class="space-y-4">
                    <textarea v-model="printText" :disabled="!connected" rows="3"
                        class="w-full bg-black/60 border border-green-500/40 rounded px-3 py-2 text-green-100 text-sm focus:outline-none focus:border-green-400"
                        placeholder="Enter text to print..."></textarea>
                    <div class="flex justify-end">
                        <button @click="sendPrint" :disabled="!connected || !printText"
                            class="px-6 py-2 font-mono border border-green-400/60 bg-green-500/10 hover:bg-green-500/20 text-green-200 rounded transition disabled:opacity-40 disabled:cursor-not-allowed">
                            print text
                        </button>
                    </div>
                </div>
            </section>

            <section class="grid gap-6 md:grid-cols-3">
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">HEATING DOTS</h2>
                        <span class="text-s">{{ settings.heatDots }}</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <div class="flex justify-between text-s text-green-400/70">
                            <span>0</span>
                            <span>15</span>
                        </div>
                        <input type="range" min="0" max="15" step="1" v-model.number="settings.heatDots"
                            @change="updateSetting('heatDots')" :disabled="!connected" class="w-full accent-green-400">
                        <p class="text-s text-green-200/70">max simultaneous elements</p>
                    </div>
                </article>
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">HEAT TIME</h2>
                        <span class="text-s">{{ settings.heatTime }} μs</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <div class="flex justify-between text-s text-green-400/70">
                            <span>0</span>
                            <span>255</span>
                        </div>
                        <input type="range" min="0" max="255" step="1" v-model.number="settings.heatTime"
                            @change="updateSetting('heatTime')" :disabled="!connected">
                        <p class="text-s text-green-200/70">pulse duration per line</p>
                    </div>
                </article>
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">HEAT INTERVAL</h2>
                        <span class="text-s">{{ settings.heatInterval }} μs</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <div class="flex justify-between text-s text-green-400/70">
                            <span>0</span>
                            <span>255</span>
                        </div>
                        <input type="range" min="0" max="255" step="1" v-model.number="settings.heatInterval"
                            @change="updateSetting('heatInterval')" :disabled="!connected">
                        <p class="text-s text-green-200/70">cool-down throttle</p>
                    </div>
                </article>
            </section>

            <section class="grid gap-6 md:grid-cols-3">
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">DENSITY</h2>
                        <span class="text-s">{{ settings.density }}</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <div class="flex justify-between text-s text-green-400/70">
                            <span>0</span>
                            <span>31</span>
                        </div>
                        <input type="range" min="0" max="31" step="1" v-model.number="settings.density"
                            @change="updateSetting('density')" :disabled="!connected">
                        <p class="text-s text-green-200/70">ink darkness envelope</p>
                    </div>
                </article>
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">BREAK TIME</h2>
                        <span class="text-s">{{ settings.breakTime * 250 }} μs</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <div class="flex justify-between text-s text-green-400/70">
                            <span>0</span>
                            <span>7</span>
                        </div>
                        <input type="range" min="0" max="7" step="1" v-model.number="settings.breakTime"
                            @change="updateSetting('breakTime')" :disabled="!connected">
                        <p class="text-s text-green-200/70">recovery parameter</p>
                    </div>
                </article>
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">LINE HEIGHT</h2>
                        <span class="text-s">{{ settings.lineHeight }} px</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <div class="flex justify-between text-s text-green-400/70">
                            <span>24</span>
                            <span>64</span>
                        </div>
                        <input type="range" min="24" max="64" step="1" v-model.number="settings.lineHeight"
                            @change="updateSetting('lineHeight')" :disabled="!connected">
                        <p class="text-s text-green-200/70">row spacing control</p>
                    </div>
                </article>
            </section>

            <section class="grid gap-6 md:grid-cols-3">
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">FONT</h2>
                        <span class="text-s">{{ settings.font ? 'B' : 'A' }}</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <select v-model.number="settings.font" @change="updateSetting('font')" :disabled="!connected"
                            class="w-full bg-black/60 border border-green-500/40 rounded px-3 py-2 text-green-100">
                            <option :value="0">Font A (standard)</option>
                            <option :value="1">Font B (compact)</option>
                        </select>
                        <p class="text-s text-green-200/70">printer glyph profile</p>
                    </div>
                </article>
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">SIZE</h2>
                        <span class="text-s">{{ sizeLabel }}</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <select v-model.number="settings.size" @change="updateSetting('size')" :disabled="!connected"
                            class="w-full bg-black/60 border border-green-500/40 rounded px-3 py-2 text-green-100">
                            <option :value="0">Small (S)</option>
                            <option :value="1">Medium (M)</option>
                            <option :value="2">Large (L)</option>
                        </select>
                        <p class="text-s text-green-200/70">height + width preset</p>
                    </div>
                </article>
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">JUSTIFY</h2>
                        <span class="text-s">{{ justifyLabel }}</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <select v-model.number="settings.justify" @change="updateSetting('justify')"
                            :disabled="!connected"
                            class="w-full bg-black/60 border border-green-500/40 rounded px-3 py-2 text-green-100">
                            <option :value="0">Left</option>
                            <option :value="1">Center</option>
                            <option :value="2">Right</option>
                        </select>
                        <p class="text-s text-green-200/70">alignment directive</p>
                    </div>
                </article>
            </section>

            <section class="grid gap-6 md:grid-cols-2">
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">CHARSET</h2>
                        <span class="text-s">{{ charsetLabel }}</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <select v-model.number="settings.charset" @change="updateSetting('charset')"
                            :disabled="!connected"
                            class="w-full bg-black/60 border border-green-500/40 rounded px-3 py-2 text-green-100">
                            <option v-for="opt in charsetOptions" :key="opt.value" :value="opt.value">
                                {{ opt.label }}
                            </option>
                        </select>
                        <p class="text-s text-green-200/70">international character set</p>
                    </div>
                </article>
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">CODE PAGE</h2>
                        <span class="text-s">{{ codePageLabel }}</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <select v-model.number="settings.codePage" @change="updateSetting('codePage')"
                            :disabled="!connected"
                            class="w-full bg-black/60 border border-green-500/40 rounded px-3 py-2 text-green-100">
                            <option v-for="opt in codePageOptions" :key="opt.value" :value="opt.value">
                                {{ opt.label }}
                            </option>
                        </select>
                        <p class="text-s text-green-200/70">extended character table</p>
                    </div>
                </article>
            </section>

            <section class="grid gap-6 md:grid-cols-2">
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)]">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">TEXT DECORATION</h2>
                        <span class="text-s">{{ decorationLabel }}</span>
                    </header>
                    <div class="mt-6 space-y-4">
                        <select v-model.number="settings.decorations" @change="updateSetting('decorations')"
                            :disabled="!connected"
                            class="w-full bg-black/60 border border-green-500/40 rounded px-3 py-2 text-green-100">
                            <option v-for="opt in decorationOptions" :key="opt.value" :value="opt.value">
                                {{ opt.label }}
                            </option>
                        </select>
                        <p class="text-s text-green-200/70">single selector for style masks</p>
                    </div>
                </article>
                <article
                    class="ghost-grid border border-green-500/20 rounded-xl p-5 bg-black/40 shadow-[0_0_30px_rgba(0,255,0,0.08)] space-y-4">
                    <header class="flex justify-between items-center text-green-300">
                        <h2 class="text-lg font-mono tracking-wide">FEED CONTROL</h2>
                        <span class="text-s">{{ settings.feed }} rows</span>
                    </header>
                    <div class="space-y-4">
                        <input type="range" min="0" max="50" step="1" v-model.number="settings.feed"
                            :disabled="!connected">
                        <div class="flex gap-4">
                            <button @click="sendFeed" :disabled="!connected || !settings.feed"
                                class="px-5 py-2 font-mono border border-green-400/60 bg-green-500/10 hover:bg-green-500/20 text-green-200 rounded disabled:opacity-40">
                                pulse feed
                            </button>
                            <button @click="settings.feed = 0" :disabled="!connected"
                                class="px-4 py-2 font-mono border border-green-500/30 text-green-200 rounded">reset</button>
                        </div>
                        <p class="text-s text-green-200/70">manual advance for testing media flow</p>
                    </div>
                </article>
            </section>

            <section class="border border-green-500/20 rounded-xl bg-black/60 p-5 space-y-4">
                <header class="flex items-center justify-between text-green-300">
                    <h3 class="tracking-[0.3em] text-s font-mono">TELEMETRY LOG</h3>
                    <button @click="clearLog"
                        class="text-s font-mono text-green-400 hover:text-green-200">clear</button>
                </header>
                <ul class="space-y-2 max-h-48 overflow-auto pr-2 text-green-200/80 text-s">
                    <li v-for="entry in log" :key="entry.id" class="flex justify-between gap-4">
                        <span>{{ entry.timestamp }}</span>
                        <span>{{ entry.text }}</span>
                    </li>
                    <li v-if="!log.length" class="text-green-500/60">awaiting signals…</li>
                </ul>
            </section>
        </main>
    </div>

    <script>
        const SERVICE_UUID = '5a1a0001-8f19-4a86-9a9e-7b4f7f9b0002';
        const CHAR_UUID = {
            heatDots: '5a1a0002-8f19-4a86-9a9e-7b4f7f9b0002',
            heatTime: '5a1a0003-8f19-4a86-9a9e-7b4f7f9b0002',
            heatInterval: '5a1a0004-8f19-4a86-9a9e-7b4f7f9b0002',
            density: '5a1a0005-8f19-4a86-9a9e-7b4f7f9b0002',
            breakTime: '5a1a0006-8f19-4a86-9a9e-7b4f7f9b0002',
            lineHeight: '5a1a0007-8f19-4a86-9a9e-7b4f7f9b0002',
            font: '5a1a0008-8f19-4a86-9a9e-7b4f7f9b0002',
            size: '5a1a0009-8f19-4a86-9a9e-7b4f7f9b0002',
            justify: '5a1a000a-8f19-4a86-9a9e-7b4f7f9b0002',
            decorations: '5a1a000b-8f19-4a86-9a9e-7b4f7f9b0002',
            feed: '5a1a000c-8f19-4a86-9a9e-7b4f7f9b0002',
            charset: '5a1a000d-8f19-4a86-9a9e-7b4f7f9b0002',
            codePage: '5a1a000e-8f19-4a86-9a9e-7b4f7f9b0002',
            printText: '5a1a000f-8f19-4a86-9a9e-7b4f7f9b0002',
            meshName: '5a1a0010-8f19-4a86-9a9e-7b4f7f9b0002',
            meshPin: '5a1a0011-8f19-4a86-9a9e-7b4f7f9b0002',
            printerRxPin: '5a1a0012-8f19-4a86-9a9e-7b4f7f9b0002',
            printerTxPin: '5a1a0013-8f19-4a86-9a9e-7b4f7f9b0002'
        };

        const encoder = new TextEncoder();
        const decoder = new TextDecoder();

        const app = {
            data() {
                return {
                    device: null,
                    server: null,
                    service: null,
                    characteristics: {},
                    handlers: {},
                    boundDisconnect: null,
                    connected: false,
                    connecting: false,
                    notificationsEnabled: false,
                    statusText: 'standby',
                    settings: {
                        heatDots: 11,
                        heatTime: 120,
                        heatInterval: 40,
                        density: 10,
                        breakTime: 2,
                        lineHeight: 30,
                        font: 0,
                        size: 0,
                        justify: 0,
                        decorations: 0,
                        feed: 0,
                        charset: 0,
                        codePage: 0,
                        meshName: '',
                        meshPin: '',
                        printerRxPin: 1,
                        printerTxPin: 2
                    },
                    printText: '',
                    decorationOptions: [
                        { value: 0, label: 'none' },
                        { value: 1, label: 'bold' },
                        { value: 2, label: 'inverse' },
                        { value: 4, label: 'strike' },
                        { value: 8, label: 'double width' },
                        { value: 9, label: 'bold + double' }
                    ],
                    charsetOptions: [
                        { value: 0, label: 'USA' },
                        { value: 1, label: 'France' },
                        { value: 2, label: 'Germany' },
                        { value: 3, label: 'UK' },
                        { value: 4, label: 'Denmark 1' },
                        { value: 5, label: 'Sweden' },
                        { value: 6, label: 'Italy' },
                        { value: 7, label: 'Spain 1' },
                        { value: 8, label: 'Japan' },
                        { value: 9, label: 'Norway' },
                        { value: 10, label: 'Denmark 2' },
                        { value: 11, label: 'Spain 2' },
                        { value: 12, label: 'Latin America' },
                        { value: 13, label: 'Korea' },
                        { value: 14, label: 'Slovenia/Croatia' },
                        { value: 15, label: 'China' }
                    ],
                    codePageOptions: [
                        { value: 0, label: 'CP437 (USA, Std Europe)' },
                        { value: 1, label: 'Katakana' },
                        { value: 2, label: 'CP850 (Multilingual)' },
                        { value: 3, label: 'CP860 (Portuguese)' },
                        { value: 4, label: 'CP863 (Canadian-French)' },
                        { value: 5, label: 'CP865 (Nordic)' },
                        { value: 6, label: 'WCP1251 (Cyrillic)' },
                        { value: 7, label: 'CP866 (Cyrillic #2)' },
                        { value: 8, label: 'MIK (Cyrillic/Bulgarian)' },
                        { value: 9, label: 'CP755 (East Europe, Latvian 2)' },
                        { value: 10, label: 'Iran 1' },
                        { value: 15, label: 'CP862 (Hebrew)' },
                        { value: 16, label: 'WCP1252 (Latin 1)' },
                        { value: 17, label: 'WCP1253 (Greek)' },
                        { value: 18, label: 'CP852 (Latin 2)' },
                        { value: 19, label: 'CP858 (Multilingual Latin 1 + Euro)' },
                        { value: 20, label: 'Iran 2' },
                        { value: 21, label: 'Latvian' },
                        { value: 22, label: 'CP864 (Arabic)' },
                        { value: 23, label: 'ISO-8859-1 (West Europe)' },
                        { value: 24, label: 'CP737 (Greek)' },
                        { value: 25, label: 'WCP1257 (Baltic)' },
                        { value: 26, label: 'Thai' },
                        { value: 27, label: 'CP720 (Arabic)' },
                        { value: 28, label: 'CP855 (Cyrillic)' },
                        { value: 29, label: 'CP857 (Turkish)' },
                        { value: 30, label: 'WCP1250 (Central Europe)' },
                        { value: 31, label: 'CP775 (Baltic)' },
                        { value: 32, label: 'WCP1254 (Turkish)' },
                        { value: 33, label: 'WCP1255 (Hebrew)' },
                        { value: 34, label: 'WCP1256 (Arabic)' },
                        { value: 35, label: 'WCP1258 (Vietnam)' },
                        { value: 36, label: 'ISO-8859-2 (Latin 2)' },
                        { value: 37, label: 'ISO-8859-3 (Latin 3)' },
                        { value: 38, label: 'ISO-8859-4 (Baltic)' },
                        { value: 39, label: 'ISO-8859-5 (Cyrillic)' },
                        { value: 40, label: 'ISO-8859-6 (Arabic)' },
                        { value: 41, label: 'ISO-8859-7 (Greek)' },
                        { value: 42, label: 'ISO-8859-8 (Hebrew)' },
                        { value: 43, label: 'ISO-8859-9 (Turkish)' },
                        { value: 44, label: 'ISO-8859-15 (Latin 3)' },
                        { value: 45, label: 'Thai 2' },
                        { value: 46, label: 'CP856 (Hebrew)' },
                        { value: 47, label: 'CP874 (Thai)' }
                    ],
                    log: [],
                    nextLogId: 0
                };
            },
            computed: {
                sizeLabel() {
                    return ['S', 'M', 'L'][this.settings.size] || 'S';
                },
                justifyLabel() {
                    return ['left', 'center', 'right'][this.settings.justify] || 'left';
                },
                decorationLabel() {
                    const match = this.decorationOptions.find(opt => opt.value === this.settings.decorations);
                    return match ? match.label : this.settings.decorations;
                },
                charsetLabel() {
                    const match = this.charsetOptions.find(opt => opt.value === this.settings.charset);
                    return match ? match.label : this.settings.charset;
                },
                codePageLabel() {
                    const match = this.codePageOptions.find(opt => opt.value === this.settings.codePage);
                    return match ? match.label : this.settings.codePage;
                }
            },
            methods: {
                setStatus(text) {
                    this.statusText = text;
                    this.pushLog(text);
                },
                pushLog(text) {
                    const stamp = new Date().toLocaleTimeString();
                    this.log.unshift({ id: this.nextLogId++, timestamp: stamp, text });
                    if (this.log.length > 50) {
                        this.log.pop();
                    }
                },
                clearLog() {
                    this.log = [];
                },
                async connect() {
                    if (!navigator.bluetooth) {
                        alert('Web Bluetooth not supported in this browser.');
                        return;
                    }
                    try {
                        this.connecting = true;
                        this.setStatus('scanning');
                        this.device = await navigator.bluetooth.requestDevice({
                            filters: [{ services: [SERVICE_UUID] }],
                            optionalServices: [SERVICE_UUID]
                        });
                        this.boundDisconnect = this.handleGattDisconnect.bind(this);
                        this.device.addEventListener('gattserverdisconnected', this.boundDisconnect);
                        this.server = await this.device.gatt.connect();
                        this.setStatus('link open');
                        this.service = await this.server.getPrimaryService(SERVICE_UUID);
                        await this.prepareCharacteristics();
                        this.connected = true;
                        this.setStatus('ready');
                    } catch (err) {
                        console.error(err);
                        this.setStatus('connect failed');
                        alert(err.message || err);
                        await this.disconnect();
                    } finally {
                        this.connecting = false;
                    }
                },
                async prepareCharacteristics() {
                    this.characteristics = {};
                    this.handlers = {};
                    let notifyCount = 0;
                    const entries = Object.entries(CHAR_UUID);
                    for (const [key, uuid] of entries) {
                        const characteristic = await this.service.getCharacteristic(uuid);
                        this.characteristics[key] = characteristic;
                        await this.readSetting(key);
                        try {
                            const handler = event => this.handleNotification(key, event);
                            characteristic.addEventListener('characteristicvaluechanged', handler);
                            await characteristic.startNotifications();
                            this.handlers[key] = handler;
                            notifyCount += 1;
                        } catch (err) {
                            console.warn('notify unsupported for', key, err);
                        }
                    }
                    this.notificationsEnabled = notifyCount > 0;
                },
                async readSetting(key) {
                    const characteristic = this.characteristics[key];
                    if (!characteristic) {
                        return;
                    }
                    const value = await characteristic.readValue();
                    const parsed = this.parseValue(value, key);
                    if (parsed !== null) {
                        this.applySetting(key, parsed);
                    }
                },
                parseValue(dataView, key) {
                    try {
                        const text = decoder.decode(dataView);
                        if (key === 'meshName' || key === 'meshPin') {
                            return text.replace(/\0/g, '');
                        }
                        const value = parseInt(text, 10);
                        return Number.isFinite(value) ? value : null;
                    } catch (err) {
                        console.error('decode failed', err);
                        return null;
                    }
                },
                applySetting(key, value) {
                    if (Object.prototype.hasOwnProperty.call(this.settings, key)) {
                        this.settings[key] = value;
                    }
                    if (key === 'decorations') {
                        const match = this.decorationOptions.find(opt => opt.value === value);
                        this.pushLog(`${key} :: ${match ? match.label : value}`);
                    } else {
                        this.pushLog(`${key} :: ${value}`);
                    }
                },
                handleNotification(key, event) {
                    const parsed = this.parseValue(event.target.value, key);
                    if (parsed !== null) {
                        this.applySetting(key, parsed);
                    }
                },
                async updateSetting(key) {
                    if (!this.connected) {
                        return;
                    }
                    const characteristic = this.characteristics[key];
                    if (!characteristic) {
                        return;
                    }
                    try {
                        const payload = encoder.encode(String(this.settings[key]));
                        await characteristic.writeValue(payload);
                        this.pushLog(`set ${key} -> ${this.settings[key]}`);
                    } catch (err) {
                        console.error(err);
                        this.setStatus('write error');
                    }
                },
                async sendFeed() {
                    if (!this.connected || !this.settings.feed) {
                        return;
                    }
                    await this.updateSetting('feed');
                    this.settings.feed = 0;
                },
                async sendPrint() {
                    if (!this.connected || !this.printText) {
                        return;
                    }
                    const characteristic = this.characteristics['printText'];
                    if (!characteristic) {
                        return;
                    }
                    try {
                        const payload = encoder.encode(this.printText);
                        await characteristic.writeValue(payload);
                        this.pushLog(`print :: ${this.printText.length} chars`);
                        this.printText = '';
                    } catch (err) {
                        console.error(err);
                        this.setStatus('print error');
                    }
                },
                async disconnect() {
                    if (this.device && this.device.gatt.connected) {
                        await this.device.gatt.disconnect();
                    }
                    this.resetLink('link closed');
                },
                handleGattDisconnect() {
                    this.resetLink('link lost');
                },
                resetLink(label) {
                    if (this.device && this.boundDisconnect) {
                        try {
                            this.device.removeEventListener('gattserverdisconnected', this.boundDisconnect);
                        } catch (err) {
                            console.warn('handler cleanup failed', err);
                        }
                    }
                    this.boundDisconnect = null;
                    Object.entries(this.characteristics).forEach(([key, characteristic]) => {
                        const handler = this.handlers[key];
                        if (handler) {
                            try {
                                characteristic.removeEventListener('characteristicvaluechanged', handler);
                            } catch (err) {
                                console.warn('remove handler failed', err);
                            }
                        }
                    });
                    this.handlers = {};
                    this.characteristics = {};
                    this.notificationsEnabled = false;
                    this.connected = false;
                    this.server = null;
                    this.service = null;
                    this.device = null;
                    this.setStatus(label || 'link closed');
                }
            },
            mounted() {
                window.addEventListener('beforeunload', () => {
                    if (this.device && this.device.gatt.connected) {
                        this.device.gatt.disconnect();
                    }
                    this.resetLink('link closed');
                });
            }
        };

        Vue.createApp(app).mount('#app');
    </script>
</body>

</html>