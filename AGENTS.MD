# Agent Task: Generate Protobufs for ESP32 Meshtastic BLE Logger

## Context

We are building a minimal ESP32 proof‑of‑concept that:

- Connects to a Meshtastic device over BLE.
- Subscribes to the `FromRadio` characteristic.
- Decodes incoming protobuf messages (Meshtastic protocol).
- Logs public‑channel text messages to the serial console.

A first version of the ESP32 Arduino sketch already exists and expects nanopb‑generated C files and headers (e.g., `meshtastic.pb.c`, `meshtastic.pb.h`) plus the nanopb runtime (`pb_*.c/.h`).

Your task is to generate these protobuf artifacts from the official Meshtastic `.proto` definitions, in a way that is compatible with the ESP32 Arduino build.

---

## Task: Generate nanopb Protobufs for Meshtastic Messages

### Goal

Produce a minimal but complete set of nanopb‑generated protobuf C files and headers that:

- Cover at least the following types:
  - `FromRadio`
  - `ToRadio`
  - `MeshPacket`
  - The decoded payload/message that carries text content
  - The `PortNum` enum (including `TEXT_MESSAGE_APP`)
- Match the field names and structure expected by the ESP32 sketch, or vice versa (if necessary, the sketch can be updated to match the actual generated schema).
- Build cleanly in the Arduino IDE for ESP32 alongside the existing sketch.

### Inputs

1. **Meshtastic `.proto` files**  
   Fetch from the main Meshtastic repository (not `meshtastic/python`), e.g.:
   - `meshtastic.proto`
   - Any other `.proto` files that those depend on (e.g., `mesh.proto`, `channel.proto`, `portnums.proto`, etc.).

2. **Nanopb compiler and runtime**
   - `protoc` (Protocol Buffers compiler).
   - `protoc-gen-nanopb` (nanopb plugin).
   - Nanopb core sources:
     - `pb.h`
     - `pb_common.c`, `pb_common.h`
     - `pb_decode.c`, `pb_decode.h`
     - `pb_encode.c`, `pb_encode.h`

---

## Steps

1. **Set up nanopb on your machine**
   - Install `protoc` if not already present.
   - Install/obtain `protoc-gen-nanopb` from the [nanopb project](https://jpa.kapsi.fi/nanopb/).
   - Ensure both are available in your `PATH`.

2. **Obtain Meshtastic `.proto` files**
   - Clone the main Meshtastic firmware repository.
   - Locate the protobuf definitions used for the radio protocol (typically under a `protobufs` or similar directory).
   - Identify which `.proto` file defines:
     - `FromRadio`
     - `ToRadio`
     - `MeshPacket`
     - The decoded text payload message
     - `PortNum`

3. **Generate nanopb files**
   - Run `protoc` with the nanopb plugin. Example (adjust for actual paths and filenames):

     ```bash
     protoc --nanopb_out=. meshtastic.proto
     ```

   - Verify that at minimum the following are produced:
     - `meshtastic.pb.c`
     - `meshtastic.pb.h`

   - If the protocol is split into multiple `.proto` files, repeat as needed, or include them in a single `protoc` invocation.

4. **Inspect the generated schema**
   - Open `meshtastic.pb.h` and confirm:
     - `meshtastic_FromRadio` struct exists and has a field that carries a `MeshPacket`.
     - `meshtastic_MeshPacket` struct has the fields needed by the sketch:
       - `from`
       - `to`
       - `channel`
       - A nested decoded payload (containing the text bytes) or raw payload field.
     - The `PortNum` enum includes a value for text messages (e.g., `meshtastic_PortNum_TEXT_MESSAGE_APP` or similar).
   - Note the exact field names and union tags (e.g., `which_payload_variant`, `payload_variant.packet`, etc.).

5. **Align with the ESP32 sketch**
   - If necessary, document any differences between the expected and actual field names/structure.
   - Prepare a short mapping or notes so that the ESP32 sketch can be updated to:
     - Use the correct `which_...` selector field.
     - Access the correct packet field.
     - Access the decoded text bytes for logging.
     - Use the correct `PortNum` enum symbol.

6. **Prepare Arduino‑ready files**
   - Collect all required files for the Arduino sketch folder:
     - `meshtastic.pb.c`
     - `meshtastic.pb.h`
     - Any additional `*.pb.c/.h` generated and required as dependencies.
     - Nanopb runtime:
       - `pb.h`
       - `pb_common.c`, `pb_common.h`
       - `pb_decode.c`, `pb_decode.h`
       - `pb_encode.c`, `pb_encode.h`
   - Ensure that there are no conflicting headers or duplicate symbol definitions.
   - Confirm that the generated code does not rely on features that are problematic for Arduino/ESP32 (e.g., unusual `#pragma` or platform‑specific includes).

7. **Output / Deliverables**

   - A set of source and header files ready to be dropped into the Arduino sketch directory:
     - `meshtastic.pb.c`
     - `meshtastic.pb.h`
     - Any other required `*.pb.c/.h`
     - Nanopb runtime `pb_*.c/.h`
   - A brief text note (can be added to this file or a separate document) specifying:
     - Which `.proto` files were used and their commit/branch.
     - The key struct/enum names and relevant fields used by the ESP32 sketch.
     - Any notable changes or caveats (e.g., “field name is `data` instead of `packet`”).

---

## Acceptance Criteria

- The generated nanopb files compile successfully with the ESP32 Arduino project (no missing symbols, no unresolved types).
- `meshtastic_FromRadio`, `meshtastic_MeshPacket`, and `meshtastic_PortNum` (or equivalent names) are available and match the Meshtastic protocol.
- The ESP32 sketch can call `pb_decode()` on incoming BLE payloads using these generated definitions without structural mismatches.
- Text messages received on the public channel can be extracted from the decoded message structures (even if the Arduino sketch still needs a small update to match field names).